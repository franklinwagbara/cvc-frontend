<div>
  <button (click)="goBack()" class="m-4 mb-2" mat-button>
    <mat-icon>keyboard_backspace</mat-icon>&nbsp;Go Back
  </button>

  <div class="form-details-container">
    <!-- Liquid Gas Form-->
    <div class="form-wrapper">
      <app-page-title />

      <hr class="w-full" />
      <hr class="w-full" />

      <mat-vertical-stepper class="pl-3 pr-2" linear #coqstepper>
        <ng-template matStepperIcon="done">
          <mat-icon>check</mat-icon>
        </ng-template>

        <mat-step
          [stepControl]="plantSelection"
          [label]="'Select Processing Plant'"
        >
          <mat-form-field appearance="fill" style="min-width: fit-content">
            <mat-label>Processing Plant</mat-label>
            <mat-select [formControl]="plantSelection">
              <mat-option
                *ngFor="let plant of processingPlants"
                [value]="plant?.id"
              >
                {{ plant?.name }}
              </mat-option>
            </mat-select>
          </mat-form-field>
          <mat-error *ngIf="noPlantFetched !== null && noPlantFetched">
            {{ "No " + "processing plant " + "available for this application" }}
          </mat-error>
          <div class="text-right">
            <button
              mat-raised-button
              matStepperNext
              (click)="plantSelection.markAllAsTouched()"
              [disabled]="
                !plantSelection.valid ||
                fetchingRequirement ||
                !plantTanks.length
              "
            >
              Next
            </button>
          </div>
          <app-capsule-card
            *ngIf="selectedPlant"
            [data]="selectedPlant"
            [colMappings]="plantColMappings"
          ></app-capsule-card>
        </mat-step>

        <mat-step [stepControl]="productSelection" label="Select Product">
          <mat-form-field appearance="fill" style="min-width: fit-content">
            <mat-label>Product</mat-label>

            <mat-select [formControl]="productSelection">
              <mat-option
                *ngFor="let product of products"
                [value]="product?.id"
              >
                {{ product?.name }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <app-capsule-card
            *ngIf="selectedProduct"
            [data]="selectedProduct"
            [colMappings]="productColMappings"
          ></app-capsule-card>

          <div class="text-right">
            <button
              mat-raised-button
              matStepperNext
              (click)="productSelection.markAllAsTouched()"
              [disabled]="!productSelection.valid"
            >
              Next
            </button>
          </div>
        </mat-step>

        <mat-step label="Tank(s) BEFORE & AFTER Data Entry">
          <mat-stepper #tankInfoStepper linear>
            <mat-step [stepControl]="configuredTank" label="Select Tank">
              <form [formGroup]="configuredTank">
                <mat-form-field>
                  <mat-label>Tank Name</mat-label>
                  <mat-select formControlName="id">
                    <mat-option
                      *ngFor="let tank of plantTanks || []"
                      [value]="tank?.plantTankId"
                    >
                      {{ tank?.tankName }}
                    </mat-option>
                  </mat-select>
                </mat-form-field>
                <mat-error
                  *ngIf="
                    (noTankConfigured !== null && noTankConfigured) ||
                    !configuredTank?.valid
                  "
                  class="mb-2 mt-0"
                >
                  {{
                    noTankConfigured !== null && noTankConfigured
                      ? "No tanks configured for the selected " +
                        "plant" +
                        " and you may not proceed"
                      : !!configuredTank?.controls["id"].hasError("duplicate")
                      ? "Tank readings already exist"
                      : ""
                  }}
                </mat-error>
              </form>

              <app-capsule-card
                *ngIf="selectedTank"
                [data]="selectedTank"
                [colMappings]="tankColMappings"
              ></app-capsule-card>

              <div class="text-right">
                <button
                  mat-raised-button
                  matStepperNext
                  color="primary"
                  [disabled]="!configuredTank?.valid"
                >
                  Continue
                </button>
              </div>
            </mat-step>

            <mat-step
              [stepControl]="measurementSelection"
              label="Select Measurement System"
            >
              <mat-form-field>
                <mat-label>Measurement System</mat-label>
                <mat-select [formControl]="measurementSelection">
                  <mat-option *ngFor="let mt of measurementTypes" [value]="mt">
                    {{ mt }}
                  </mat-option>
                </mat-select>
              </mat-form-field>
              <div class="text-right">
                <button
                  mat-raised-button
                  matStepperNext
                  color="primary"
                  [disabled]="!measurementSelection?.valid"
                >
                  Continue
                </button>
              </div>
            </mat-step>

            <mat-step
              [stepControl]="getForm('before')"
              label="Enter BEFORE data"
            >
              <app-liquid-data-dynamic-entry
                *ngIf="!isGasProduct && getForm('before') && isDynamicSystem"
                [form]="getForm('before')"
                [isBefore]="true"
              />
              <app-gas-data-dynamic-entry
                *ngIf="isGasProduct && getForm('before') && isDynamicSystem"
                [form]="getForm('before')"
                [isBefore]="true"
              />

              <app-liquid-data-static-entry
                *ngIf="!isGasProduct && getForm('before') && isDynamicSystem"
                [form]="getForm('before')"
                [isBefore]="true"
              />
              <app-gas-data-static-entry
                *ngIf="isGasProduct && getForm('before') && isDynamicSystem"
                [form]="getForm('before')"
                [isBefore]="true"
              />
              <div class="mt-4 text-right">
                <button
                  mat-raised-button
                  matStepperNext
                  color="primary"
                  [disabled]="getForm('before')?.invalid"
                >
                  Continue
                </button>
              </div>
            </mat-step>

            <mat-step [stepControl]="getForm('after')" label="Enter AFTER data">
              <app-liquid-data-dynamic-entry
                *ngIf="!isGasProduct && getForm('after') && !isDynamicSystem"
                [form]="getForm('after')"
                [isBefore]="false"
              />
              <app-gas-data-dynamic-entry
                *ngIf="isGasProduct && getForm('after') && !isDynamicSystem"
                [form]="getForm('after')"
                [isBefore]="false"
              />

              <app-liquid-data-static-entry
                *ngIf="!isGasProduct && getForm('after') && !isDynamicSystem"
                [form]="getForm('after')"
                [isBefore]="false"
              />
              <app-gas-data-static-entry
                *ngIf="isGasProduct && getForm('after') && !isDynamicSystem"
                [form]="getForm('after')"
                [isBefore]="false"
              />

              <div class="mt-4 text-right">
                <button
                  mat-raised-button
                  matStepperNext
                  color="primary"
                  (click)="saveToReview()"
                  [disabled]="getForm('after')?.invalid"
                >
                  Save
                </button>
              </div>
            </mat-step>
          </mat-stepper>

          <div class="mt-4 overflow-x-auto">
            <h4 class="text-slate-600 font-medium">Review & Proceed</h4>
            <hr />
            <ng-container *ngIf="!isGasProduct">
              <div
                *ngIf="
                  coqFormService?.liquidProductReviewData.length;
                  else noReview
                "
              >
                <app-coq-form-review
                  [isGasProduct]="isGasProduct"
                ></app-coq-form-review>
              </div>
            </ng-container>
            <ng-container *ngIf="isGasProduct">
              <div
                *ngIf="
                  coqFormService?.gasProductReviewData.length;
                  else noReview
                "
              >
                <app-coq-form-review
                  [isGasProduct]="isGasProduct"
                ></app-coq-form-review>
              </div>
            </ng-container>

            <div class="text-right">
              <button
                class="mt-4"
                mat-raised-button
                color="primary"
                matStepperNext
                [disabled]="
                  !isGasProduct
                    ? !coqFormService?.liquidProductReviewData.length
                    : !coqFormService.gasProductReviewData.length
                "
              >
                Proceed
              </button>
            </div>

            <ng-template #noReview>
              <p class="text-slate-600 text-center">
                No Certificate of Quantity Data pending submission
              </p>
            </ng-template>
          </div>
        </mat-step>

        <mat-step
          [stepControl]="!isGasProduct ? vesselLiqInfoForm : vesselGasInfoForm"
          [label]="
            (isProcessingPlant ? 'Truck' : 'Shore Tank') +
            ' Ullage Details Entry'
          "
        >
          <ng-container *ngIf="!isGasProduct">
            <ng-container
              *ngTemplateOutlet="vesselLiqInfoFormTmp"
            ></ng-container>
          </ng-container>
          <ng-container *ngIf="isGasProduct">
            <ng-container
              *ngTemplateOutlet="vesselGasInfoFormTmp"
            ></ng-container>
          </ng-container>
          <div class="text-right">
            <button
              mat-raised-button
              matStepperNext
              (click)="vesselLiqInfoForm.markAllAsTouched()"
              [disabled]="
                !isGasProduct
                  ? vesselLiqInfoForm.invalid
                  : vesselGasInfoForm.invalid
              "
            >
              Next
            </button>
          </div>
        </mat-step>

        <ng-template #vesselLiqInfoFormTmp>
          <form [formGroup]="vesselLiqInfoForm">
            <div
              class="w-[90%] grid gap-4 gap-y-2 text-sm grid-cols-1 md:grid-cols-9 mb-4"
            >
              <div class="md:col-span-9 flex flex-col lg:flex-row gap-4 pr-2">
                <mat-form-field>
                  <mat-label
                    >Date of
                    {{ isProcessingPlant ? "Truck" : "Vessel" }}
                    Arrival</mat-label
                  >
                  <div class="flex">
                    <input
                      matInput
                      formControlName="dateOfVesselArrival"
                      [matDatepicker]="arrivalDatePicker"
                      [min]="dateValidation.min"
                      [max]="dateValidation.max"
                    />
                    <mat-datepicker-toggle
                      matIconSuffix
                      [for]="arrivalDatePicker"
                    ></mat-datepicker-toggle>
                    <mat-datepicker #arrivalDatePicker></mat-datepicker>
                  </div>
                </mat-form-field>

                <mat-form-field>
                  <mat-label
                    >Date of
                    {{ isProcessingPlant ? "Truck" : "Vessel" }}
                    Ullage</mat-label
                  >
                  <div class="flex">
                    <input
                      matInput
                      formControlName="dateOfVesselUllage"
                      [matDatepicker]="ullageDatePicker"
                      [min]="dateValidation.min"
                      [max]="dateValidation.max"
                    />
                    <mat-datepicker-toggle
                      matIconSuffix
                      [for]="ullageDatePicker"
                    ></mat-datepicker-toggle>
                    <mat-datepicker #ullageDatePicker></mat-datepicker>
                  </div>
                </mat-form-field>

                <mat-form-field>
                  <mat-label
                    >Date of {{ isProcessingPlant ? "Truck" : "Vessel" }} After
                    Discharge</mat-label
                  >
                  <div class="flex">
                    <input
                      matInput
                      formControlName="dateOfSTAfterDischarge"
                      [matDatepicker]="shoreTankDatePicker"
                      [min]="dateValidation.min"
                      [max]="dateValidation.max"
                    />
                    <mat-datepicker-toggle
                      matIconSuffix
                      [for]="shoreTankDatePicker"
                    ></mat-datepicker-toggle>
                    <mat-datepicker #shoreTankDatePicker></mat-datepicker>
                  </div>
                </mat-form-field>
              </div>

              <div class="md:col-span-3">
                <label for="coq-liquid-product-mtvac"
                  >{{ isProcessingPlant ? "Plant" : "Expot-Depot" }} Price<sup
                    class="text-red-700"
                    >*</sup
                  ></label
                >
                <input
                  type="number"
                  name="depotPrice"
                  formControlName="depotPrice"
                  id="coq-liquid-product-ex-depot-price"
                  class="form-field form-control"
                  [ngClass]="{
                    'is-invalid':
                      vesselLiqInfoForm.controls['depotPrice'].touched &&
                      vesselLiqInfoForm.controls['depotPrice'].invalid
                  }"
                />
              </div>
            </div>
          </form>
        </ng-template>

        <ng-template #vesselGasInfoFormTmp>
          <form [formGroup]="vesselGasInfoForm">
            <div
              class="w-[90%] grid gap-4 gap-y-2 text-sm grid-cols-1 md:grid-cols-12 mb-4"
            >
              <div class="md:col-span-12 flex flex-col lg:flex-row gap-4 pr-2">
                <mat-form-field class="md:col-span-6">
                  <mat-label
                    >Date of
                    {{ isProcessingPlant ? "Truck" : "Vessel" }}
                    Arrival</mat-label
                  >
                  <div class="flex">
                    <input
                      matInput
                      name="vesselArrivalDate"
                      formControlName="vesselArrivalDate"
                      [matDatepicker]="arrivalDatePicker"
                      [min]="dateValidation.min"
                      [max]="dateValidation.max"
                    />
                    <mat-datepicker-toggle
                      matIconSuffix
                      [for]="arrivalDatePicker"
                    ></mat-datepicker-toggle>
                    <mat-datepicker #arrivalDatePicker></mat-datepicker>
                  </div>
                </mat-form-field>
                <mat-form-field class="md:col-span-6">
                  <mat-label
                    >Date of Commencement of Product Discharge</mat-label
                  >
                  <div class="flex">
                    <input
                      matInput
                      name="prodDischargeCommenceDate"
                      formControlName="prodDischargeCommenceDate"
                      [matDatepicker]="prodDischargeCommenceDatePicker"
                      [min]="dateValidation.min"
                      [max]="dateValidation.max"
                    />
                    <mat-datepicker-toggle
                      matIconSuffix
                      [for]="prodDischargeCommenceDatePicker"
                    ></mat-datepicker-toggle>
                    <mat-datepicker
                      #prodDischargeCommenceDatePicker
                    ></mat-datepicker>
                  </div>
                </mat-form-field>
                <mat-form-field class="md:col-span-6">
                  <mat-label>Date of Completion of Product Discharge</mat-label>
                  <div class="flex">
                    <input
                      matInput
                      name="prodDischargeCompletionDate"
                      formControlName="prodDischargeCompletionDate"
                      [matDatepicker]="prodDischargeCompletionDatePicker"
                      [min]="dateValidation.min"
                      [max]="dateValidation.max"
                    />
                    <mat-datepicker-toggle
                      matIconSuffix
                      [for]="prodDischargeCompletionDatePicker"
                    ></mat-datepicker-toggle>
                    <mat-datepicker
                      #prodDischargeCompletionDatePicker
                    ></mat-datepicker>
                  </div>
                </mat-form-field>
              </div>
              <div class="md:col-span-6">
                <label for="coq-gas-product-gov"
                  >Qty Reflected on Bill of Lading (MT Air)
                  <sup class="text-red-700">*</sup></label
                >
                <input
                  type="number"
                  name="qtyBillLadingMtAir"
                  formControlName="qtyBillLadingMtAir"
                  id="coq-gas-product-qtyBillLadingMtAir"
                  class="form-field form-control"
                  [ngClass]="{
                    'is-invalid':
                      vesselGasInfoForm.controls['qtyBillLadingMtAir']
                        .touched &&
                      vesselGasInfoForm.controls['qtyBillLadingMtAir'].invalid
                  }"
                />
              </div>

              <div class="md:col-span-6">
                <label for="coq-gas-product-arrivalShipMtAir"
                  >Arrival SHIP Figure (MT Air)
                  <sup class="text-red-700">*</sup></label
                >
                <input
                  type="number"
                  name="arrivalShipMtAir"
                  formControlName="arrivalShipMtAir"
                  id="coq-gas-product-arrivalShipMtAir"
                  class="form-field form-control"
                  [ngClass]="{
                    'is-invalid':
                      vesselGasInfoForm.controls['arrivalShipMtAir'].touched &&
                      vesselGasInfoForm.controls['arrivalShipMtAir'].invalid
                  }"
                />
              </div>

              <div class="md:col-span-6">
                <label for="coq-gas-product-shipDischargedMtAir"
                  >SHIP Figure (DISCHARGED) (MT Air)
                  <sup class="text-red-700">*</sup></label
                >
                <input
                  type="number"
                  name="shipDischargedMtAir"
                  formControlName="shipDischargedMtAir"
                  id="coq-gas-product-shipDischargedMtAir"
                  class="form-field form-control"
                  [ngClass]="{
                    'is-invalid':
                      vesselGasInfoForm.controls['shipDischargedMtAir']
                        .touched &&
                      vesselGasInfoForm.controls['shipDischargedMtAir'].invalid
                  }"
                />
              </div>
              <div class="md:col-span-6">
                <label for="coq-gas-product-depotPrice"
                  >Depot Price <sup class="text-red-700">*</sup></label
                >
                <input
                  type="number"
                  name="depotPrice"
                  formControlName="depotPrice"
                  id="coq-gas-product-depotPrice"
                  class="form-field form-control"
                  [ngClass]="{
                    'is-invalid':
                      vesselGasInfoForm.controls['depotPrice'].touched &&
                      vesselGasInfoForm.controls['depotPrice'].invalid
                  }"
                />
              </div>
              <div class="md:col-span-6">
                <label for="coq-gas-product-nameConsignee"
                  >Name of Consignor/Consignee
                  <sup class="text-red-700">*</sup></label
                >
                <input
                  type="text"
                  name="nameConsignee"
                  formControlName="nameConsignee"
                  id="coq-gas-product-nameConsignee"
                  class="form-field form-control"
                  [ngClass]="{
                    'is-invalid':
                      vesselGasInfoForm.controls['nameConsignee'].touched &&
                      vesselGasInfoForm.controls['nameConsignee'].invalid
                  }"
                />
              </div>
            </div>
          </form>
        </ng-template>

        <mat-step label="Document(s) Upload">
          <div class="w-[90%] mb-4 p-0">
            <div class="guidelines">
              <h4>Please Note</h4>
              <ul class="guidelines-list">
                <li>
                  All documents listed below are required and must be uploaded.
                  Subsequently, other documents may be needed and will be added
                  to this list.
                </li>
                <li>
                  The Maximum file size allowed is <strong>20MB</strong> per
                  document, any file size greater than this value will not be
                  uploaded.
                </li>
                <li>
                  Only <strong>JPEG</strong>, <strong>PNG</strong>,
                  <strong>JPG</strong>, and <strong>PDF</strong> file types are
                  allowed on this platform.
                </li>
              </ul>
            </div>

            <div id="coq_doc_upload_table_description" class="hidden">
              Document Upload Table
            </div>

            <div class="table-container mat-elevation-z8">
              <div class="table-title">REQUIRED DOCUMENTS</div>
              <h4 *ngIf="spinner.isOpen" class="text-center">Loading....</h4>
              <table
                *ngIf="!spinner.isOpen"
                mat-table
                [dataSource]="dataSource"
                aria-describedby="coq_doc_upload_table_description"
              >
                <ng-container
                  *ngFor="let column of displayedColumns"
                  [matColumnDef]="column"
                >
                  <th
                    mat-header-cell
                    *matHeaderCellDef
                    class="text-slate-700 text-[16px] text-left"
                  >
                    {{ column | uppercase }}
                  </th>
                  <td
                    mat-cell
                    *matCellDef="let element; let i = index"
                    class="text-left"
                  >
                    <ng-container *ngIf="column === 'document'">
                      <div class="flex justify-start align-middle">
                        <span
                          class="truncate max-w-40"
                          [title]="element.docName"
                        >
                          {{ element?.docName }}</span
                        >&nbsp;
                      </div>
                    </ng-container>

                    <ng-container *ngIf="column === 'action'">
                      <button
                        mat-button
                        class="upload-btn"
                        (click)="triggerFileInput(i)"
                      >
                        {{ element?.docSource ? "Replace" : "Upload" }}
                      </button>

                      <input
                        class="d-none file-input"
                        type="file"
                        accept=".png,.jpg,.jpeg,.pdf"
                        (change)="onFileSelected($event, i)"
                      />
                    </ng-container>

                    <ng-container *ngIf="column === 'source'">
                      <div>
                        <a
                          *ngIf="element?.docSource"
                          [href]="element?.docSource"
                          target="_blank"
                          download
                          ><img
                            src="../../../assets/image/pdfIcon.png"
                            width="30"
                            height="30"
                            alt="Facility Document"
                        /></a>
                      </div>
                    </ng-container>

                    <ng-container *ngIf="column === 'progress'">
                      <div class="flex flex-col items-center justify-center">
                        <span
                          *ngIf="
                            documents?.length > 0 && documents[i]?.fileName
                          "
                          class="font-bold text-slate-500"
                          >{{
                            documents[i]?.fileName +
                              " (" +
                              documents[i]?.fileSizeInKb +
                              "Kb)"
                          }}</span
                        >
                        <mat-progress-bar
                          mode="determinate"
                          [value]="
                            documents?.length > 0
                              ? documents[i]?.percentProgress
                              : 0
                          "
                          [ngClass]="{
                            'in-progress':
                              documents?.length > 0 &&
                              documents[i]?.success === null,
                            success:
                              documents?.length > 0 && documents[i]?.success,
                            failed:
                              documents?.length > 0 && !documents[i]?.success
                          }"
                        >
                        </mat-progress-bar>
                      </div>
                    </ng-container>
                  </td>
                </ng-container>

                <tr
                  mat-header-row
                  *matHeaderRowDef="displayedColumns"
                  class="rounded-md shadow-lg"
                ></tr>
                <tr
                  mat-row
                  *matRowDef="let row; columns: displayedColumns"
                ></tr>
              </table>
            </div>

            <div
              *ngIf="hasUploadedAllRequiredDocs && !isSubmitted"
              class="flex justify-between mt-8"
            >
              <button
                *ngIf="!isSubmitted"
                mat-button
                (click)="preview()"
                class="action bg-yellow-500 hover:bg-yellow-600"
              >
                Preview
              </button>
              <button
                *ngIf="!isSubmitted"
                type="submit"
                (click)="submit()"
                mat-button
                class="action bg-green-500 hover:bg-green-600"
                [disabled]="isSubmitting"
              >
                Submit
              </button>
            </div>
          </div>

          <ng-template #noRequiredDocsWarn>
            <div
              class="bg-yellow-100 w-[90%] border border-yellow-400 text-yellow-700 px-4 py-3 rounded relative"
              role="alert"
            >
              <strong class="font-bold"
                >No Required Documents Configured:&nbsp;&nbsp;</strong
              >
              <span class="block sm:inline"
                >You may not proceed with this application.</span
              >
            </div>
          </ng-template>
        </mat-step>
      </mat-vertical-stepper>
    </div>
  </div>
</div>
